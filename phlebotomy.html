<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phlebotomy Problem-Solving & Troubleshooting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeIn 0.8s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .section:nth-child(1) { animation-delay: 0.2s; }
        .section:nth-child(2) { animation-delay: 0.4s; }
        .section:nth-child(3) { animation-delay: 0.6s; }
        .section:nth-child(4) { animation-delay: 0.8s; }

        h2 {
            color: #2c3e50;
            border-left: 5px solid #667eea;
            padding-left: 15px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        h3 {
            color: #34495e;
            margin: 20px 0 10px 0;
            font-size: 1.3em;
        }

        .complication-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .complication-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .complication-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .complication-card h3 {
            color: #667eea;
            margin-top: 0;
        }

        .stat-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        canvas {
            max-width: 100%;
        }

        .quiz-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
        }

        .question {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .question h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .option {
            background: #f8f9fa;
            padding: 12px 20px;
            margin: 8px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .option:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .option.incorrect {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scenario-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            border: 3px solid #667eea;
        }

        .scenario {
            display: none;
        }

        .scenario.active {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .action-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .action-btn.correct-action {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .action-btn.incorrect-action {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .feedback {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }

        .feedback.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        .feedback.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .feedback.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .tip-box {
            background: #e7f3ff;
            border-left: 5px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        li {
            margin: 8px 0;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }
            
            .complication-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü©∏ Phlebotomy Problem-Solving & Troubleshooting</h1>
            <p>Master the skills to recognize and correct common complications</p>
        </header>

        <div class="content">
            <!-- Introduction Section -->
            <div class="section">
                <h2>üìö Learning Objectives</h2>
                <p>In this lesson, you will learn to:</p>
                <ul>
                    <li>Identify common complications during blood collection procedures</li>
                    <li>Recognize early warning signs of patient distress and equipment failure</li>
                    <li>Apply appropriate corrective actions for each complication</li>
                    <li>Prioritize patient safety in emergency situations</li>
                    <li>Document complications according to professional standards</li>
                </ul>
            </div>

            <!-- Statistics Section -->
            <div class="section">
                <h2>üìä Complication Statistics</h2>
                <div class="stat-container">
                    <p><strong>Understanding the frequency of phlebotomy complications helps us prepare:</strong></p>
                    <div class="chart-container">
                        <canvas id="complicationChart"></canvas>
                    </div>
                    <p style="text-align: center; margin-top: 15px; color: #666;">
                        <em>Data based on clinical studies of 4,000+ venipunctures</em>
                    </p>
                </div>
            </div>

            <!-- Common Complications Section -->
            <div class="section">
                <h2>üîç Common Complications Overview</h2>
                <div class="complication-grid">
                    <div class="complication-card" onclick="showDetails('failed-draw')">
                        <h3>üéØ Failed Draw</h3>
                        <p><strong>Incidence:</strong> Varies by patient factors</p>
                        <p><strong>Key Signs:</strong> No blood flow, slow/intermittent flow</p>
                        <p><strong>Primary Causes:</strong> Needle positioning, vein collapse, lost vacuum</p>
                    </div>

                    <div class="complication-card" onclick="showDetails('syncope')">
                        <h3>üòµ Syncope/Fainting</h3>
                        <p><strong>Incidence:</strong> 0.3-5% of patients</p>
                        <p><strong>Key Signs:</strong> Pallor, perspiration, dizziness, loss of consciousness</p>
                        <p><strong>Primary Cause:</strong> Vasovagal response</p>
                    </div>

                    <div class="complication-card" onclick="showDetails('hematoma')">
                        <h3>ü©π Hematoma</h3>
                        <p><strong>Incidence:</strong> 12.3% (minor bruising most common)</p>
                        <p><strong>Key Signs:</strong> Swelling, discoloration, mounding of tissue</p>
                        <p><strong>Primary Causes:</strong> Inadequate pressure, needle through vein</p>
                    </div>

                    <div class="complication-card" onclick="showDetails('equipment')">
                        <h3>‚öôÔ∏è Equipment Malfunction</h3>
                        <p><strong>Common Issues:</strong> Lost vacuum, defective tubes, needle problems</p>
                        <p><strong>Key Signs:</strong> Tube doesn't fill, vacuum lost</p>
                        <p><strong>Prevention:</strong> Equipment inspection, proper storage</p>
                    </div>
                </div>
            </div>

            <!-- Interactive Knowledge Check -->
            <div class="section">
                <h2>‚úÖ Knowledge Check Quiz</h2>
                <div class="quiz-container">
                    <div id="quiz"></div>
                    <div class="action-buttons" style="justify-content: center;">
                        <button class="btn" onclick="checkAnswers()" id="submitQuiz">Submit Answers</button>
                        <button class="btn" onclick="resetQuiz()" id="resetQuiz" style="display: none;">Try Again</button>
                    </div>
                    <div id="quizFeedback" class="feedback"></div>
                    <div id="scoreDisplay" style="display: none;"></div>
                </div>
            </div>

            <!-- Interactive Scenario Activity -->
            <div class="section">
                <h2>üéÆ Interactive Scenario Challenge</h2>
                <div class="tip-box">
                    <strong>üí° Instructions:</strong> Work through realistic scenarios and choose the best course of action. 
                    Your decisions will be evaluated based on professional standards and patient safety protocols.
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="scenarioProgress">Scenario 1 of 4</div>
                </div>

                <div class="scenario-container">
                    <div id="scenario1" class="scenario active">
                        <h3>Scenario 1: Rapid Hematoma Formation</h3>
                        <p><strong>Situation:</strong> You've inserted the needle and started collecting blood. Suddenly, you notice the area around the puncture site beginning to swell rapidly. The patient reports increasing discomfort.</p>
                        
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Patient Status:</strong> Alert, reporting pain (6/10), visible swelling increasing
                        </div>

                        <p><strong>What should you do FIRST?</strong></p>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="checkAction(1, 'A')">
                                A) Continue the draw to complete specimen collection
                            </button>
                            <button class="action-btn" onclick="checkAction(1, 'B')">
                                B) Immediately terminate the draw and activate needle safety
                            </button>
                            <button class="action-btn" onclick="checkAction(1, 'C')">
                                C) Adjust the needle angle to see if that helps
                            </button>
                            <button class="action-btn" onclick="checkAction(1, 'D')">
                                D) Release the tourniquet but continue drawing
                            </button>
                        </div>
                        <div id="feedback1" class="feedback"></div>
                    </div>

                    <div id="scenario2" class="scenario">
                        <h3>Scenario 2: Patient Showing Signs of Syncope</h3>
                        <p><strong>Situation:</strong> Midway through the blood draw, your patient says "I feel dizzy." You notice they are pale, perspiring, and breathing rapidly. The needle is still in their arm with one tube left to fill.</p>
                        
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Patient Status:</strong> Dizzy, pale, diaphoretic, hyperventilating, needle in arm
                        </div>

                        <p><strong>What is your PRIORITY action?</strong></p>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="checkAction(2, 'A')">
                                A) Quickly finish filling the last tube
                            </button>
                            <button class="action-btn" onclick="checkAction(2, 'B')">
                                B) Secure the needle immediately, then assist patient
                            </button>
                            <button class="action-btn" onclick="checkAction(2, 'C')">
                                C) Help the patient lie down while maintaining the draw
                            </button>
                            <button class="action-btn" onclick="checkAction(2, 'D')">
                                D) Remove the needle and catch the patient if they fall
                            </button>
                        </div>
                        <div id="feedback2" class="feedback"></div>
                    </div>

                    <div id="scenario3" class="scenario">
                        <h3>Scenario 3: No Blood Flow</h3>
                        <p><strong>Situation:</strong> You've inserted the needle at what felt like the correct angle and depth, but no blood is flowing into the tube. You can see flashback in the butterfly tubing, confirming you're in the vein.</p>
                        
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Status:</strong> Needle appears to be in vein (flashback visible), but tube not filling
                        </div>

                        <p><strong>What troubleshooting steps should you try? (Select the BEST answer)</strong></p>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="checkAction(3, 'A')">
                                A) Probe deeper and move the needle around to find blood
                            </button>
                            <button class="action-btn" onclick="checkAction(3, 'B')">
                                B) Try a new tube, adjust angle slightly, release tourniquet if vein collapsed
                            </button>
                            <button class="action-btn" onclick="checkAction(3, 'C')">
                                C) Remove and start over with a new needle in the same spot
                            </button>
                            <button class="action-btn" onclick="checkAction(3, 'D')">
                                D) Apply more vacuum by using a larger tube
                            </button>
                        </div>
                        <div id="feedback3" class="feedback"></div>
                    </div>

                    <div id="scenario4" class="scenario">
                        <h3>Scenario 4: Equipment Problem - Lost Vacuum</h3>
                        <p><strong>Situation:</strong> You insert a collection tube and notice it doesn't fill at all. You verify the needle is properly positioned in the vein. You try a second tube from the same batch with the same result.</p>
                        
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Status:</strong> Proper technique, needle in vein, but tubes not filling from same batch
                        </div>

                        <p><strong>What is the most likely problem and solution?</strong></p>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="checkAction(4, 'A')">
                                A) Patient's vein is too small - use smaller gauge needle
                            </button>
                            <button class="action-btn" onclick="checkAction(4, 'B')">
                                B) Tubes have lost vacuum - try tubes from different batch
                            </button>
                            <button class="action-btn" onclick="checkAction(4, 'C')">
                                C) Tourniquet too tight - release and reapply
                            </button>
                            <button class="action-btn" onclick="checkAction(4, 'D')">
                                D) Wrong collection method - switch to syringe draw
                            </button>
                        </div>
                        <div id="feedback4" class="feedback"></div>
                    </div>
                </div>

                <div class="action-buttons" style="justify-content: center;">
                    <button class="btn" onclick="previousScenario()" id="prevBtn" style="display: none;">‚Üê Previous</button>
                    <button class="btn" onclick="nextScenario()" id="nextBtn" style="display: none;">Next ‚Üí</button>
                    <button class="btn" onclick="showResults()" id="resultsBtn" style="display: none;">View Results</button>
                </div>

                <div id="finalResults" style="display: none;"></div>
            </div>

            <!-- Best Practices Section -->
            <div class="section">
                <h2>‚≠ê Key Takeaways</h2>
                
                <div class="tip-box">
                    <h3>Priority Protocol for Syncope</h3>
                    <ol>
                        <li><strong>FIRST:</strong> Secure the needle (activate safety feature)</li>
                        <li><strong>SECOND:</strong> Position patient (head between knees or supine)</li>
                        <li><strong>THIRD:</strong> Monitor and call for assistance if needed</li>
                        <li><strong>NEVER:</strong> Turn your back on patient or leave them unattended</li>
                    </ol>
                </div>

                <div class="tip-box">
                    <h3>Preventing Hematomas</h3>
                    <ul>
                        <li>Select appropriate vein (prefer median veins)</li>
                        <li>Ensure needle fully penetrates uppermost vein wall</li>
                        <li>Release tourniquet before removing needle</li>
                        <li>Apply adequate pressure for 3-5 minutes (longer for anticoagulation patients)</li>
                        <li>Check for both superficial bleeding AND tissue mounding</li>
                    </ul>
                </div>

                <div class="warning-box">
                    <h3>Critical Safety Rules</h3>
                    <ul>
                        <li>Never probe - remove needle if vein is missed</li>
                        <li>Never reuse a needle that has been inserted</li>
                        <li>Never draw from an artery as alternative to difficult draw</li>
                        <li>Never bandage without checking for complete stasis</li>
                        <li>Never ignore shooting/electric pain (indicates nerve contact)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Quiz data
        const quizQuestions = [
            {
                question: "What percentage of patients experience syncope during or immediately after blood draws?",
                options: [
                    "Less than 1%",
                    "0.3-5%",
                    "10-15%",
                    "15-20%"
                ],
                correct: 1
            },
            {
                question: "When a patient begins to faint during a blood draw, what should you do FIRST?",
                options: [
                    "Catch the patient to prevent falling",
                    "Quickly finish filling the tube",
                    "Activate needle safety and secure the needle",
                    "Call for help"
                ],
                correct: 2
            },
            {
                question: "What is the most common complication in phlebotomy?",
                options: [
                    "Nerve damage",
                    "Syncope",
                    "Minor bruising and hematoma",
                    "Infection"
                ],
                correct: 2
            },
            {
                question: "If blood is flowing slowly into the tube, which troubleshooting step should you try?",
                options: [
                    "Probe around to find better blood flow",
                    "Try a different tube or adjust needle angle slightly",
                    "Push the needle in deeper",
                    "Use a larger gauge needle immediately"
                ],
                correct: 1
            },
            {
                question: "How long should pressure be applied to prevent hematoma formation?",
                options: [
                    "30 seconds",
                    "1 minute",
                    "3-5 minutes (longer for anticoagulation patients)",
                    "Until the patient says it feels better"
                ],
                correct: 2
            },
            {
                question: "What does it mean when a collection tube has 'lost its vacuum'?",
                options: [
                    "The tube is too cold",
                    "Air has entered the tube, eliminating suction",
                    "The tube has expired",
                    "Both B and C are possible causes"
                ],
                correct: 3
            }
        ];

        // Scenario tracking
        let currentScenario = 1;
        let scenarioAnswers = {};
        let correctScenarios = 0;

        // Create complication statistics chart
        function createChart() {
            const ctx = document.getElementById('complicationChart').getContext('2d');
            const data = {
                labels: ['Minor Bruising/Hematoma', 'Vasovagal Response', 'Syncope', 'Other Serious Complications'],
                datasets: [{
                    label: 'Percentage of Occurrences',
                    data: [12.3, 2.6, 0.8, 0.6],
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(75, 192, 192, 0.7)'
                    ],
                    borderColor: [
                        'rgba(102, 126, 234, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 2
                }]
            };

            // Simple bar chart implementation
            const maxValue = Math.max(...data.datasets[0].data);
            const canvas = document.getElementById('complicationChart');
            canvas.height = 300;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = canvas.width / data.labels.length - 40;
            const padding = 60;
            
            data.labels.forEach((label, index) => {
                const value = data.datasets[0].data[index];
                const barHeight = (value / maxValue) * (canvas.height - padding * 2);
                const x = index * (barWidth + 40) + 20;
                const y = canvas.height - padding - barHeight;
                
                // Draw bar
                ctx.fillStyle = data.datasets[0].backgroundColor[index];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw border
                ctx.strokeStyle = data.datasets[0].borderColor[index];
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, barWidth, barHeight);
                
                // Draw value
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value + '%', x + barWidth/2, y - 5);
                
                // Draw label
                ctx.font = '11px Arial';
                ctx.save();
                ctx.translate(x + barWidth/2, canvas.height - 10);
                ctx.rotate(-Math.PI/6);
                ctx.fillText(label, 0, 0);
                ctx.restore();
            });
            
            // Draw Y axis
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(15, padding);
            ctx.lineTo(15, canvas.height - padding);
            ctx.stroke();
            
            // Y axis label
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 12px Arial';
            ctx.save();
            ctx.translate(5, canvas.height/2);
            ctx.rotate(-Math.PI/2);
            ctx.textAlign = 'center';
            ctx.fillText('Percentage (%)', 0, 0);
            ctx.restore();
        }

        // Generate quiz
        function generateQuiz() {
            const quizContainer = document.getElementById('quiz');
            let html = '';
            
            quizQuestions.forEach((q, index) => {
                html += `
                    <div class="question">
                        <h4>Question ${index + 1}</h4>
                        <p>${q.question}</p>
                        ${q.options.map((option, optIndex) => `
                            <div class="option" onclick="selectOption(${index}, ${optIndex})">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            quizContainer.innerHTML = html;
        }

        let selectedAnswers = {};

        function selectOption(questionIndex, optionIndex) {
            // Remove previous selection
            const question = document.querySelectorAll('.question')[questionIndex];
            question.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // Add new selection
            question.querySelectorAll('.option')[optionIndex].classList.add('selected');
            selectedAnswers[questionIndex] = optionIndex;
        }

        function checkAnswers() {
            let correct = 0;
            const feedback = document.getElementById('quizFeedback');
            
            quizQuestions.forEach((q, index) => {
                const question = document.querySelectorAll('.question')[index];
                const options = question.querySelectorAll('.option');
                
                options.forEach((option, optIndex) => {
                    option.onclick = null; // Disable further clicks
                    
                    if (optIndex === q.correct) {
                        option.classList.add('correct');
                    } else if (selectedAnswers[index] === optIndex) {
                        option.classList.add('incorrect');
                    }
                });
                
                if (selectedAnswers[index] === q.correct) {
                    correct++;
                }
            });
            
            const percentage = Math.round((correct / quizQuestions.length) * 100);
            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.innerHTML = `<div class="score-display">Score: ${correct}/${quizQuestions.length} (${percentage}%)</div>`;
            scoreDisplay.style.display = 'block';
            
            feedback.className = 'feedback show ' + (percentage >= 70 ? 'success' : 'error');
            feedback.innerHTML = percentage >= 70 
                ? `<strong>Excellent!</strong> You've demonstrated strong understanding of phlebotomy troubleshooting. Score: ${percentage}%`
                : `<strong>Review needed.</strong> Please review the material and try again. Score: ${percentage}%`;
            
            document.getElementById('submitQuiz').style.display = 'none';
            document.getElementById('resetQuiz').style.display = 'inline-block';
        }

        function resetQuiz() {
            selectedAnswers = {};
            generateQuiz();
            document.getElementById('quizFeedback').classList.remove('show');
            document.getElementById('scoreDisplay').style.display = 'none';
            document.getElementById('submitQuiz').style.display = 'inline-block';
            document.getElementById('resetQuiz').style.display = 'none';
        }

        // Scenario functions
        function checkAction(scenarioNum, answer) {
            const correctAnswers = {
                1: 'B', // Immediately terminate draw for hematoma
                2: 'B', // Secure needle first for syncope
                3: 'B', // Proper troubleshooting for no flow
                4: 'B'  // Lost vacuum issue
            };
            
            const feedbackMessages = {
                1: {
                    correct: "‚úÖ <strong>Correct!</strong> When a hematoma rapidly forms, you must prioritize minimizing tissue damage over completing the specimen collection. Immediately terminate the draw and activate the needle safety device. Then apply firm pressure to prevent further bleeding.",
                    incorrect: "‚ùå <strong>Incorrect.</strong> The correct action is to immediately terminate the draw and activate needle safety. Continuing the draw or adjusting the needle will only worsen the hematoma. The priority is minimizing patient harm, not completing the collection."
                },
                2: {
                    correct: "‚úÖ <strong>Correct!</strong> Needle safety is ALWAYS the first priority when a patient shows signs of syncope. An accidental needlestick injury is more serious than a bruise from an incomplete draw. Secure the needle first, then help the patient into a safe position.",
                    incorrect: "‚ùå <strong>Incorrect.</strong> Your FIRST priority must be securing the needle before helping the patient. A falling patient with an unsecured needle creates serious risk of injury to both patient and phlebotomist. Never attempt to finish the draw when syncope signs appear."
                },
                3: {
                    correct: "‚úÖ <strong>Correct!</strong> These are appropriate troubleshooting steps: trying a new tube (vacuum may be lost), slightly adjusting the needle angle (bevel may be against vein wall), or releasing the tourniquet (if vacuum is too strong and collapsing the vein). Never probe.",
                    incorrect: "‚ùå <strong>Incorrect.</strong> Never probe or move the needle around - this risks nerve injury. The correct approach is to try a new tube, make minor angle adjustments, or release the tourniquet. If these don't work, remove the needle and try a different site."
                },
                4: {
                    correct: "‚úÖ <strong>Correct!</strong> When multiple tubes from the same batch don't fill despite proper technique, the most likely cause is lost vacuum in the tubes. This can occur from expired tubes, defective manufacturing, or improper storage. Try tubes from a different batch.",
                    incorrect: "‚ùå <strong>Incorrect.</strong> The issue is most likely lost vacuum in the tube batch. Blood collection tubes can lose vacuum over time or due to damage. When proper technique doesn't produce results with multiple tubes from the same batch, try a different batch."
                }
            };
            
            const isCorrect = answer === correctAnswers[scenarioNum];
            scenarioAnswers[scenarioNum] = isCorrect;
            if (isCorrect) correctScenarios++;
            
            // Update button styling
            const scenario = document.getElementById(`scenario${scenarioNum}`);
            const buttons = scenario.querySelectorAll('.action-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent.trim().startsWith(answer)) {
                    btn.classList.add(isCorrect ? 'correct-action' : 'incorrect-action');
                } else if (btn.textContent.trim().startsWith(correctAnswers[scenarioNum])) {
                    btn.classList.add('correct-action');
                }
            });
            
            // Show feedback
            const feedback = document.getElementById(`feedback${scenarioNum}`);
            feedback.className = 'feedback show ' + (isCorrect ? 'success' : 'error');
            feedback.innerHTML = isCorrect ? feedbackMessages[scenarioNum].correct : feedbackMessages[scenarioNum].incorrect;
            
            // Show next button
            if (scenarioNum < 4) {
                document.getElementById('nextBtn').style.display = 'inline-block';
            } else {
                document.getElementById('resultsBtn').style.display = 'inline-block';
            }
        }

        function nextScenario() {
            document.getElementById(`scenario${currentScenario}`).classList.remove('active');
            currentScenario++;
            document.getElementById(`scenario${currentScenario}`).classList.add('active');
            
            updateProgress();
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('prevBtn').style.display = 'inline-block';
            
            if (currentScenario === 4) {
                document.getElementById('nextBtn').style.display = 'none';
            }
        }

        function previousScenario() {
            document.getElementById(`scenario${currentScenario}`).classList.remove('active');
            currentScenario--;
            document.getElementById(`scenario${currentScenario}`).classList.add('active');
            
            updateProgress();
            
            if (currentScenario === 1) {
                document.getElementById('prevBtn').style.display = 'none';
            }
        }

        function updateProgress() {
            const progress = (currentScenario / 4) * 100;
            const progressBar = document.getElementById('scenarioProgress');
            progressBar.style.width = progress + '%';
            progressBar.textContent = `Scenario ${currentScenario} of 4`;
        }

        function showResults() {
            const percentage = Math.round((correctScenarios / 4) * 100);
            const resultsDiv = document.getElementById('finalResults');
            
            let performanceMessage = '';
            if (percentage === 100) {
                performanceMessage = 'üèÜ <strong>Perfect Score!</strong> You have mastered phlebotomy troubleshooting protocols.';
            } else if (percentage >= 75) {
                performanceMessage = '‚≠ê <strong>Excellent Work!</strong> You demonstrate strong decision-making skills.';
            } else if (percentage >= 50) {
                performanceMessage = 'üëç <strong>Good Effort!</strong> Review the feedback and key concepts to improve.';
            } else {
                performanceMessage = 'üìö <strong>Keep Learning!</strong> Review the material and practice the scenarios again.';
            }
            
            resultsDiv.innerHTML = `
                <div class="score-display" style="margin: 20px 0;">
                    <h3>Scenario Challenge Results</h3>
                    <div style="font-size: 2em; margin: 20px 0;">${correctScenarios}/4 Correct (${percentage}%)</div>
                    <p>${performanceMessage}</p>
                </div>
                <div class="tip-box">
                    <h3>üéØ Remember:</h3>
                    <ul>
                        <li>Patient safety always comes first</li>
                        <li>Needle security is the priority in emergencies</li>
                        <li>Never probe - remove and restart if needed</li>
                        <li>Proper troubleshooting prevents complications</li>
                        <li>Documentation is essential for quality improvement</li>
                    </ul>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            document.getElementById('resultsBtn').style.display = 'none';
        }

        function showDetails(complication) {
            const details = {
                'failed-draw': `
                    <h3>Failed Draw - Troubleshooting Guide</h3>
                    <p><strong>Common Causes:</strong></p>
                    <ul>
                        <li>Needle not fully in vein (partial penetration)</li>
                        <li>Needle through the vein</li>
                        <li>Needle bevel against vein wall</li>
                        <li>Vein collapsed (vacuum too strong)</li>
                        <li>Lost vacuum in collection tube</li>
                    </ul>
                    <p><strong>Appropriate Actions:</strong></p>
                    <ul>
                        <li>Try a new tube (may have lost vacuum)</li>
                        <li>Adjust needle angle slightly (don't probe)</li>
                        <li>Release tourniquet if vein collapsed</li>
                        <li>If unsuccessful, remove and try different site</li>
                    </ul>
                `,
                'syncope': `
                    <h3>Syncope/Fainting - Emergency Response</h3>
                    <p><strong>Warning Signs:</strong></p>
                    <ul>
                        <li>Pallor (pale appearance)</li>
                        <li>Diaphoresis (perspiration)</li>
                        <li>Hyperventilation</li>
                        <li>Dizziness or lightheadedness</li>
                        <li>Nausea</li>
                    </ul>
                    <p><strong>CRITICAL Protocol:</strong></p>
                    <ol>
                        <li><strong>FIRST:</strong> Secure needle immediately (activate safety)</li>
                        <li><strong>SECOND:</strong> Position patient safely (head between knees or supine)</li>
                        <li><strong>THIRD:</strong> Monitor and call for help if needed</li>
                        <li>Never leave patient unattended</li>
                        <li>Document incident thoroughly</li>
                    </ol>
                `,
                'hematoma': `
                    <h3>Hematoma Formation - Prevention & Management</h3>
                    <p><strong>Causes:</strong></p>
                    <ul>
                        <li>Needle penetrating through vein</li>
                        <li>Inadequate pressure after draw</li>
                        <li>Tourniquet not released before needle removal</li>
                        <li>Patient bending arm instead of applying direct pressure</li>
                    </ul>
                    <p><strong>Prevention:</strong></p>
                    <ul>
                        <li>Select appropriate vein (prefer median veins)</li>
                        <li>Ensure needle fully penetrates uppermost wall only</li>
                        <li>Release tourniquet before removing needle</li>
                        <li>Apply firm pressure for 3-5 minutes</li>
                        <li>Check for both superficial bleeding AND tissue swelling</li>
                    </ul>
                    <p><strong>If Rapid Formation Occurs:</strong></p>
                    <ul>
                        <li>Immediately terminate the draw</li>
                        <li>Priority: Minimize hematoma over completing specimen</li>
                        <li>Apply firm pressure</li>
                        <li>Document in patient record</li>
                    </ul>
                `,
                'equipment': `
                    <h3>Equipment Malfunction - Recognition & Solutions</h3>
                    <p><strong>Common Issues:</strong></p>
                    <ul>
                        <li><strong>Lost Vacuum:</strong> Tube doesn't fill despite proper technique</li>
                        <li><strong>Causes:</strong> Expired tubes, defective manufacturing, improper storage, damaged seal</li>
                        <li><strong>Solution:</strong> Try tube from different batch</li>
                    </ul>
                    <ul>
                        <li><strong>Needle Problems:</strong> Dull, bent, or improperly manufactured</li>
                        <li><strong>Solution:</strong> Never reuse needle; start with new equipment</li>
                    </ul>
                    <ul>
                        <li><strong>Tube Additives:</strong> Wrong tube for test, expired additives</li>
                        <li><strong>Solution:</strong> Verify tube color and expiration dates</li>
                    </ul>
                    <p><strong>Prevention:</strong></p>
                    <ul>
                        <li>Inspect equipment before use</li>
                        <li>Check expiration dates</li>
                        <li>Store tubes properly (temperature, position)</li>
                        <li>Report defective equipment batches</li>
                    </ul>
                `
            };
            
            alert(details[complication]);
        }

        // Initialize everything when page loads
        window.onload = function() {
            createChart();
            generateQuiz();
            updateProgress();
        };
    </script>
</body>
</html>
