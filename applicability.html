<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST SP 800-171 Applicability Checklist Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .organization-info {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .org-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-control {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .progress-overview {
            background: #ffffff;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .progress-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 4px solid #3498db;
            transition: transform 0.3s ease;
        }

        .progress-card:hover {
            transform: translateY(-2px);
        }

        .progress-card h3 {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-card .number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .progress-card .percentage {
            font-size: 12px;
            color: #6c757d;
        }

        .controls-section {
            padding: 20px;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-filter {
            background: #6c757d;
            color: white;
        }

        .btn-filter.active {
            background: #3498db;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-action {
            background: #28a745;
            color: white;
        }

        .btn-export {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            width: 300px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .domains-container {
            margin-top: 20px;
        }

        .domain-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .domain-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .domain-header {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .domain-header:hover {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
        }

        .domain-title {
            font-size: 18px;
            font-weight: 600;
        }

        .domain-progress {
            font-size: 14px;
            opacity: 0.9;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            font-size: 20px;
        }

        .domain-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .domain-content {
            display: none;
            padding: 25px;
        }

        .domain-card.expanded .domain-content {
            display: block;
        }

        .practice-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .practice-item:hover {
            background: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .practice-info {
            flex: 1;
            margin-right: 20px;
        }

        .practice-id {
            font-weight: 700;
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .practice-description {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .level-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }

        .level-1 { background: #28a745; }
        .level-2 { background: #ffc107; color: #212529; }
        .level-3 { background: #dc3545; }

        .applicability-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 300px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .checkbox-group:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-label {
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        .applicable {
            color: #28a745;
        }

        .not-applicable {
            color: #dc3545;
        }

        .rationale-section {
            margin-top: 15px;
            display: none;
        }

        .rationale-section.show {
            display: block;
        }

        .rationale-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            transition: border-color 0.3s ease;
        }

        .rationale-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .character-count {
            font-size: 11px;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }

        .character-count.warning {
            color: #ffc107;
        }

        .character-count.limit {
            color: #dc3545;
            font-weight: bold;
        }

        .practice-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-applicable {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-not-applicable {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }

        .export-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        .summary-section {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .controls-header {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-controls {
                justify-content: center;
            }

            .search-input {
                width: 100%;
            }

            .practice-header {
                flex-direction: column;
            }

            .applicability-controls {
                min-width: auto;
                margin-top: 15px;
            }

            .org-form {
                grid-template-columns: 1fr;
            }
        }

        .validation-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
        }

        .batch-controls {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .batch-controls h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NIST SP 800-171 Applicability Checklist</h1>
            <div class="subtitle">Organizational Control Assessment & Implementation Planning Tool</div>
        </div>

        <div class="organization-info">
            <div class="org-form">
                <div class="form-group">
                    <label class="form-label">Organization Name *</label>
                    <input type="text" class="form-control" id="orgName" placeholder="Enter organization name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">CISO Name *</label>
                    <input type="text" class="form-control" id="cisoName" placeholder="Enter CISO name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Assessment Date</label>
                    <input type="date" class="form-control" id="assessmentDate" value="">
                </div>
                <div class="form-group">
                    <label class="form-label">CUI Categories</label>
                    <select class="form-control" id="cuiCategories" multiple>
                        <option value="PROPIN">Proprietary Information</option>
                        <option value="PRVCY">Privacy Information</option>
                        <option value="CTI">Critical Technology Information</option>
                        <option value="EXPORT">Export Controlled Information</option>
                        <option value="ITAR">ITAR Information</option>
                        <option value="OTHER">Other CUI</option>
                    </select>
                </div>
            </div>
            
            <div class="batch-controls">
                <h4>Batch Operations</h4>
                <div class="batch-actions">
                    <button class="btn btn-action" onclick="markAllApplicable()">Mark All Applicable</button>
                    <button class="btn btn-action" onclick="markLevelApplicable(1)">Mark Level 1 Applicable</button>
                    <button class="btn btn-action" onclick="markLevelApplicable(2)">Mark Level 2 Applicable</button>
                    <button class="btn btn-action" onclick="clearAllSelections()">Clear All</button>
                    <button class="btn btn-export" onclick="saveProgress()">Save Progress</button>
                </div>
            </div>
        </div>

        <div class="progress-overview">
            <div class="progress-card">
                <h3>Total Controls</h3>
                <div class="number" id="totalControls">97</div>
                <div class="percentage">NIST SP 800-171 Rev. 3</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%" id="totalProgress"></div>
                </div>
            </div>
            <div class="progress-card">
                <h3>Applicable</h3>
                <div class="number" id="applicableControls" style="color: #28a745;">0</div>
                <div class="percentage" id="applicablePercentage">0%</div>
            </div>
            <div class="progress-card">
                <h3>Not Applicable</h3>
                <div class="number" id="notApplicableControls" style="color: #dc3545;">0</div>
                <div class="percentage" id="notApplicablePercentage">0%</div>
            </div>
            <div class="progress-card">
                <h3>Pending Review</h3>
                <div class="number" id="pendingControls" style="color: #ffc107;">97</div>
                <div class="percentage" id="pendingPercentage">100%</div>
            </div>
            <div class="progress-card">
                <h3>Implementation Required</h3>
                <div class="number" id="implementationRequired" style="color: #17a2b8;">0</div>
                <div class="percentage">Ready for Audit</div>
            </div>
        </div>

        <div class="controls-section">
            <div class="controls-header">
                <div class="filter-controls">
                    <span style="font-weight: 600; margin-right: 10px;">Filter:</span>
                    <button class="btn btn-filter active" onclick="filterByLevel('all')" id="filter-all">All Levels</button>
                    <button class="btn btn-filter" onclick="filterByLevel(1)" id="filter-1">Level 1</button>
                    <button class="btn btn-filter" onclick="filterByLevel(2)" id="filter-2">Level 2</button>
                    <button class="btn btn-filter" onclick="filterByLevel(3)" id="filter-3">Level 3</button>
                    <button class="btn btn-filter" onclick="filterByStatus('applicable')" id="filter-applicable">Applicable</button>
                    <button class="btn btn-filter" onclick="filterByStatus('not-applicable')" id="filter-not-applicable">Not Applicable</button>
                    <button class="btn btn-filter" onclick="filterByStatus('pending')" id="filter-pending">Pending</button>
                </div>
                
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search controls..." onkeyup="searchControls(this.value)">
                </div>
            </div>

            <div class="domains-container" id="domainsContainer"></div>
        </div>

        <div class="summary-section">
            <h3>Assessment Summary</h3>
            <div class="summary-grid" id="summaryGrid"></div>
        </div>

        <div class="export-section">
            <div class="export-controls">
                <button class="btn btn-export" onclick="exportApplicabilityMatrix()">Export Applicability Matrix</button>
                <button class="btn btn-export" onclick="exportImplementationList()">Export Implementation List</button>
                <button class="btn btn-export" onclick="exportAuditReadiness()">Export Audit Readiness Report</button>
                <button class="btn btn-action" onclick="generateSSP()">Generate SSP Template</button>
                <button class="btn btn-action" onclick="showValidationReport()">Validation Report</button>
            </div>
        </div>
    </div>

    <!-- Validation Modal -->
    <div id="validationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Applicability Assessment Validation</h2>
                <span class="close" onclick="closeModal('validationModal')">&times;</span>
            </div>
            <div id="validationContent"></div>
        </div>
    </div>

    <script>
        // NIST SP 800-171 Rev. 3 data structure
        const nistControls = {
            domains: [
                {
                    name: "Access Control (AC)",
                    id: "AC",
                    practices: [
                        { id: "AC.L1-3.1.1", description: "Limit system access to authorized users, processes acting on behalf of users, and devices (including other systems).", level: 1 },
                        { id: "AC.L1-3.1.2", description: "Limit system access to the types of transactions and functions that authorized users are permitted to execute.", level: 1 },
                        { id: "AC.L2-3.1.3", description: "Control the flow of CUI in accordance with approved authorizations.", level: 2 },
                        { id: "AC.L2-3.1.4", description: "Separate the duties of individuals to reduce the risk of malevolent activity without collusion.", level: 2 },
                        { id: "AC.L2-3.1.5", description: "Employ the principle of least privilege, including for specific security functions and privileged accounts.", level: 2 }
                    ]
                },
                {
                    name: "Awareness and Training (AT)",
                    id: "AT",
                    practices: [
                        { id: "AT.L1-3.2.1", description: "Ensure that managers, system administrators, and users of organizational systems are made aware of the security risks associated with their activities and of the applicable policies, standards, and procedures related to the security of those systems.", level: 1 },
                        { id: "AT.L1-3.2.2", description: "Ensure that personnel are trained to carry out their assigned information security-related duties and responsibilities.", level: 1 },
                        { id: "AT.L2-3.2.3", description: "Provide security awareness training on recognizing and reporting potential indicators of insider threat.", level: 2 }
                    ]
                },
                {
                    name: "Audit and Accountability (AU)",
                    id: "AU",
                    practices: [
                        { id: "AU.L1-3.3.1", description: "Create and retain system audit logs and records to the extent needed to enable the monitoring, analysis, investigation, and reporting of unlawful or unauthorized system activity.", level: 1 },
                        { id: "AU.L1-3.3.2", description: "Ensure that the actions of individual system users can be uniquely traced to those users so they can be held accountable for their actions.", level: 1 },
                        { id: "AU.L2-3.3.3", description: "Review and update logged events.", level: 2 },
                        { id: "AU.L2-3.3.4", description: "Alert in the event of an audit logging process failure.", level: 2 },
                        { id: "AU.L2-3.3.5", description: "Correlate audit record review, analysis, and reporting processes for investigation and response to indications of unlawful, unauthorized, suspicious, or unusual activity.", level: 2 },
                        { id: "AU.L2-3.3.6", description: "Provide audit record reduction and report generation to support on-demand analysis and reporting.", level: 2 },
                        { id: "AU.L2-3.3.7", description: "Provide a system capability that compares and synchronizes audit records with other audit records for consistency.", level: 2 },
                        { id: "AU.L2-3.3.8", description: "Protect audit information and audit logging tools from unauthorized access, modification, and deletion.", level: 2 },
                        { id: "AU.L2-3.3.9", description: "Limit management of audit logging functionality to a subset of privileged users.", level: 2 }
                    ]
                },
                {
                    name: "Configuration Management (CM)",
                    id: "CM",
                    practices: [
                        { id: "CM.L1-3.4.1", description: "Establish and maintain baseline configurations and inventories of organizational systems (including hardware, software, firmware, and documentation) throughout the respective system development life cycles.", level: 1 },
                        { id: "CM.L1-3.4.2", description: "Establish and enforce security configuration settings for information technology products employed in organizational systems.", level: 1 },
                        { id: "CM.L2-3.4.3", description: "Track, review, approve, or disapprove, and log changes to organizational systems.", level: 2 },
                        { id: "CM.L2-3.4.4", description: "Analyze the security impact of changes prior to implementation.", level: 2 },
                        { id: "CM.L2-3.4.5", description: "Define, document, approve, and enforce physical and logical access restrictions associated with changes to organizational systems.", level: 2 },
                        { id: "CM.L2-3.4.6", description: "Employ the principle of least functionality by configuring organizational systems to provide only essential capabilities.", level: 2 },
                        { id: "CM.L2-3.4.7", description: "Restrict, disable, or prevent the use of nonessential programs, functions, ports, protocols, and services.", level: 2 },
                        { id: "CM.L2-3.4.8", description: "Apply deny-by-exception (blacklisting) policy to prevent the use of unauthorized software or deny-all, permit-by-exception (whitelisting) policy to allow the execution of authorized software.", level: 2 },
                        { id: "CM.L2-3.4.9", description: "Control and monitor user-installed software.", level: 2 }
                    ]
                },
                {
                    name: "Identification and Authentication (IA)",
                    id: "IA",
                    practices: [
                        { id: "IA.L1-3.5.1", description: "Identify system users, processes acting on behalf of users, and devices.", level: 1 },
                        { id: "IA.L1-3.5.2", description: "Authenticate (or verify) the identities of users, processes, or devices, as a prerequisite to allowing access to organizational systems.", level: 1 },
                        { id: "IA.L2-3.5.3", description: "Use multifactor authentication for local and network access to privileged accounts and for network access to non-privileged accounts.", level: 2 },
                        { id: "IA.L2-3.5.4", description: "Employ replay-resistant authentication mechanisms for network access to privileged and non-privileged accounts.", level: 2 },
                        { id: "IA.L2-3.5.5", description: "Prevent reuse of identifiers for a defined period.", level: 2 },
                        { id: "IA.L2-3.5.6", description: "Disable identifiers after a defined period of inactivity.", level: 2 },
                        { id: "IA.L2-3.5.7", description: "Enforce a minimum password complexity and change of characters when new passwords are created.", level: 2 },
                        { id: "IA.L2-3.5.8", description: "Prohibit password reuse for a specified number of generations.", level: 2 },
                        { id: "IA.L2-3.5.9", description: "Allow temporary password use for system logons with an immediate change to a permanent password.", level: 2 },
                        { id: "IA.L2-3.5.10", description: "Store and transmit only cryptographically-protected passwords.", level: 2 },
                        { id: "IA.L2-3.5.11", description: "Obscure feedback of authentication information.", level: 2 }
                    ]
                },
                {
                    name: "Incident Response (IR)",
                    id: "IR",
                    practices: [
                        { id: "IR.L1-3.6.1", description: "Establish an operational incident-handling capability for organizational systems that includes preparation, detection, analysis, containment, recovery, and user response activities.", level: 1 },
                        { id: "IR.L1-3.6.2", description: "Track, document, and report incidents to designated officials and/or authorities both internal and external to the organization.", level: 1 },
                        { id: "IR.L2-3.6.3", description: "Test the organizational incident response capability.", level: 2 }
                    ]
                },
                {
                    name: "Maintenance (MA)",
                    id: "MA",
                    practices: [
                        { id: "MA.L1-3.7.1", description: "Perform maintenance on organizational systems.", level: 1 },
                        { id: "MA.L1-3.7.2", description: "Provide controls on the tools, techniques, mechanisms, and personnel used to conduct system maintenance.", level: 1 },
                        { id: "MA.L2-3.7.3", description: "Ensure equipment removed for off-site maintenance is sanitized of any CUI.", level: 2 },
                        { id: "MA.L2-3.7.4", description: "Check media containing diagnostic and test programs for malicious code before the media are used in organizational systems.", level: 2 },
                        { id: "MA.L2-3.7.5", description: "Require multifactor authentication to establish nonlocal maintenance sessions via external network connections and terminate such connections when nonlocal maintenance is complete.", level: 2 },
                        { id: "MA.L2-3.7.6", description: "Supervise the maintenance activities of maintenance personnel without required access authorization.", level: 2 }
                    ]
                },
                {
                    name: "Media Protection (MP)",
                    id: "MP",
                    practices: [
                        { id: "MP.L1-3.8.1", description: "Protect (i.e., physically control and securely store) system media containing CUI, both paper and digital.", level: 1 },
                        { id: "MP.L1-3.8.2", description: "Limit access to CUI on system media to authorized users.", level: 1 },
                        { id: "MP.L1-3.8.3", description: "Sanitize or destroy system media containing CUI before disposal or release for reuse.", level: 1 },
                        { id: "MP.L2-3.8.4", description: "Mark media with necessary CUI markings and distribution limitations.", level: 2 },
                        { id: "MP.L2-3.8.5", description: "Prohibit the use of portable storage devices when such devices have no identifiable owner.", level: 2 },
                        { id: "MP.L2-3.8.6", description: "Implement cryptographic mechanisms to protect the confidentiality of CUI stored on digital media during transport unless otherwise protected by alternative physical safeguards.", level: 2 },
                        { id: "MP.L2-3.8.7", description: "Control the use of removable media on system components.", level: 2 },
                        { id: "MP.L2-3.8.8", description: "Prohibit the use of portable storage devices when such devices have no identifiable owner.", level: 2 },
                        { id: "MP.L2-3.8.9", description: "Protect the confidentiality of backup CUI at storage locations.", level: 2 }
                    ]
                },
                {
                    name: "Personnel Security (PS)",
                    id: "PS",
                    practices: [
                        { id: "PS.L1-3.9.1", description: "Screen individuals prior to authorizing access to organizational systems containing CUI.", level: 1 },
                        { id: "PS.L1-3.9.2", description: "Ensure that organizational systems containing CUI are protected during and after personnel actions such as terminations and transfers.", level: 1 }
                    ]
                },
                {
                    name: "Physical Protection (PE)",
                    id: "PE",
                    practices: [
                        { id: "PE.L1-3.10.1", description: "Limit physical access to organizational systems, equipment, and the respective operating environments to authorized individuals.", level: 1 },
                        { id: "PE.L1-3.10.2", description: "Protect and monitor the physical facility and support infrastructure for organizational systems.", level: 1 },
                        { id: "PE.L2-3.10.3", description: "Escort visitors and monitor visitor activity.", level: 2 },
                        { id: "PE.L2-3.10.4", description: "Maintain audit logs of physical access.", level: 2 },
                        { id: "PE.L2-3.10.5", description: "Control and manage physical access devices.", level: 2 },
                        { id: "PE.L2-3.10.6", description: "Enforce safeguarding measures for CUI at alternate work sites.", level: 2 }
                    ]
                },
                {
                    name: "Risk Assessment (RA)",
                    id: "RA",
                    practices: [
                        { id: "RA.L1-3.11.1", description: "Periodically assess the risk to organizational operations (including mission, functions, image, or reputation), organizational assets, and individuals, resulting from the operation of organizational systems and the associated processing, storage, or transmission of CUI.", level: 1 },
                        { id: "RA.L2-3.11.2", description: "Scan for vulnerabilities in organizational systems and applications periodically and when new vulnerabilities affecting those systems and applications are identified.", level: 2 },
                        { id: "RA.L2-3.11.3", description: "Remediate vulnerabilities in accordance with risk assessments.", level: 2 }
                    ]
                },
                {
                    name: "System and Communications Protection (SC)",
                    id: "SC",
                    practices: [
                        { id: "SC.L1-3.13.1", description: "Monitor, control, and protect organizational communications (i.e., information transmitted or received by organizational systems) at the external boundaries and key internal boundaries of organizational systems.", level: 1 },
                        { id: "SC.L1-3.13.2", description: "Employ architectural designs, software development techniques, and systems engineering principles that promote effective information security within organizational systems.", level: 1 },
                        { id: "SC.L2-3.13.3", description: "Separate user functionality from system management functionality.", level: 2 },
                        { id: "SC.L2-3.13.4", description: "Prevent unauthorized and unintended information transfer via shared system resources.", level: 2 },
                        { id: "SC.L2-3.13.5", description: "Implement subnetworks for publicly accessible system components that are physically or logically separated from internal networks.", level: 2 },
                        { id: "SC.L2-3.13.6", description: "Deny network communications traffic by default and allow network communications traffic by exception (i.e., deny all, permit by exception).", level: 2 },
                        { id: "SC.L2-3.13.7", description: "Prevent remote devices from simultaneously establishing non-remote connections with organizational systems and communicating via some other connection to resources in external networks (i.e., split tunneling).", level: 2 },
                        { id: "SC.L2-3.13.8", description: "Implement cryptographic mechanisms to prevent unauthorized disclosure of CUI during transmission unless otherwise protected by alternative physical safeguards.", level: 2 },
                        { id: "SC.L2-3.13.9", description: "Terminate network connections associated with communications sessions at the end of the sessions or after a defined period of inactivity.", level: 2 },
                        { id: "SC.L2-3.13.10", description: "Establish and manage cryptographic keys for cryptography employed in organizational systems.", level: 2 },
                        { id: "SC.L2-3.13.11", description: "Employ FIPS-validated cryptography when used to protect the confidentiality of CUI.", level: 2 },
                        { id: "SC.L2-3.13.12", description: "Prohibit remote activation of collaborative computing devices and provide indication of devices in use to users present at the device.", level: 2 },
                        { id: "SC.L2-3.13.13", description: "Control and monitor the use of mobile code.", level: 2 },
                        { id: "SC.L2-3.13.14", description: "Control and monitor the use of Voice over Internet Protocol (VoIP) technologies.", level: 2 },
                        { id: "SC.L2-3.13.15", description: "Protect the authenticity of communications sessions.", level: 2 },
                        { id: "SC.L2-3.13.16", description: "Protect the confidentiality of CUI at rest.", level: 2 }
                    ]
                },
                {
                    name: "System and Information Integrity (SI)",
                    id: "SI",
                    practices: [
                        { id: "SI.L1-3.14.1", description: "Identify, report, and correct system flaws in a timely manner.", level: 1 },
                        { id: "SI.L1-3.14.2", description: "Provide protection from malicious code at designated locations within organizational systems.", level: 1 },
                        { id: "SI.L1-3.14.3", description: "Monitor system security alerts and advisories and take action in response.", level: 1 },
                        { id: "SI.L1-3.14.4", description: "Update malicious code protection mechanisms when new releases are available.", level: 1 },
                        { id: "SI.L1-3.14.5", description: "Perform periodic scans of organizational systems and real-time scans of files from external sources as files are downloaded, opened, or executed.", level: 1 },
                        { id: "SI.L2-3.14.6", description: "Monitor organizational systems, including inbound and outbound communications traffic, to detect attacks and indicators of potential attacks.", level: 2 },
                        { id: "SI.L2-3.14.7", description: "Identify unauthorized use of organizational systems.", level: 2 }
                    ]
                }
            ]
        };

        // Application state
        let applicabilityData = {};
        let currentFilter = 'all';
        let currentStatusFilter = 'all';

        // Initialize application
        function initializeApp() {
            // Set default date
            document.getElementById('assessmentDate').value = new Date().toISOString().split('T')[0];
            
            // Generate controls interface
            generateControlsInterface();
            updateProgressMetrics();
            updateSummary();
            
            // Load saved data if available
            loadSavedData();
        }

        // Generate the controls interface
        function generateControlsInterface() {
            const container = document.getElementById('domainsContainer');
            container.innerHTML = '';

            nistControls.domains.forEach(domain => {
                const domainCard = document.createElement('div');
                domainCard.className = 'domain-card';
                domainCard.setAttribute('data-domain', domain.id);

                const domainProgress = calculateDomainProgress(domain);
                
                domainCard.innerHTML = `
                    <div class="domain-header" onclick="toggleDomain('${domain.id}')">
                        <div>
                            <div class="domain-title">${domain.name}</div>
                            <div class="domain-progress">
                                ${domainProgress.applicable} applicable, ${domainProgress.notApplicable} not applicable, 
                                ${domainProgress.pending} pending (${domain.practices.length} total)
                            </div>
                        </div>
                        <div class="expand-icon">▼</div>
                    </div>
                    <div class="domain-content">
                        ${generatePracticesHTML(domain.practices)}
                    </div>
                `;

                container.appendChild(domainCard);
            });
        }

        // Generate HTML for practices within a domain
        function generatePracticesHTML(practices) {
            return practices.map(practice => {
                const status = getApplicabilityStatus(practice.id);
                const rationale = applicabilityData[practice.id]?.rationale || '';
                
                return `
                    <div class="practice-item" data-practice-id="${practice.id}" data-level="${practice.level}">
                        <div class="practice-header">
                            <div class="practice-info">
                                <div class="practice-id">
                                    ${practice.id}
                                    <span class="level-indicator level-${practice.level}">Level ${practice.level}</span>
                                </div>
                                <div class="practice-description">${practice.description}</div>
                            </div>
                            <div class="applicability-controls">
                                <div class="practice-status ${getStatusClass(status)}">${getStatusLabel(status)}</div>
                                
                                <div class="checkbox-group">
                                    <input type="checkbox" id="applicable-${practice.id}" 
                                           ${status === 'applicable' ? 'checked' : ''} 
                                           onchange="updateApplicability('${practice.id}', 'applicable', this.checked)">
                                    <label for="applicable-${practice.id}" class="checkbox-label applicable">
                                        Applicable to Organization
                                    </label>
                                </div>
                                
                                <div class="checkbox-group">
                                    <input type="checkbox" id="not-applicable-${practice.id}" 
                                           ${status === 'not-applicable' ? 'checked' : ''} 
                                           onchange="updateApplicability('${practice.id}', 'not-applicable', this.checked)">
                                    <label for="not-applicable-${practice.id}" class="checkbox-label not-applicable">
                                        Not Applicable
                                    </label>
                                </div>
                                
                                <div class="rationale-section ${status === 'not-applicable' ? 'show' : ''}" id="rationale-${practice.id}">
                                    <label for="rationale-text-${practice.id}" class="form-label">Rationale for Non-Applicability (32 chars max):</label>
                                    <input type="text" 
                                           id="rationale-text-${practice.id}" 
                                           class="rationale-input" 
                                           maxlength="32"
                                           placeholder="Brief reason (32 chars max)..."
                                           value="${rationale}"
                                           oninput="updateRationale('${practice.id}', this.value)"
                                           onkeyup="updateCharacterCount('${practice.id}')">
                                    <div class="character-count" id="char-count-${practice.id}">
                                        <span id="current-count-${practice.id}">${rationale.length}</span>/32 characters
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle domain expansion
        function toggleDomain(domainId) {
            const domainCard = document.querySelector(`[data-domain="${domainId}"]`);
            domainCard.classList.toggle('expanded');
        }

        // Update applicability status
        function updateApplicability(practiceId, type, checked) {
            if (!applicabilityData[practiceId]) {
                applicabilityData[practiceId] = {};
            }

            if (checked) {
                applicabilityData[practiceId].status = type;
                
                // Uncheck the other checkbox
                const otherType = type === 'applicable' ? 'not-applicable' : 'applicable';
                const otherCheckbox = document.getElementById(`${otherType}-${practiceId}`);
                if (otherCheckbox) {
                    otherCheckbox.checked = false;
                }
            } else {
                applicabilityData[practiceId].status = 'pending';
            }

            updatePracticeDisplay(practiceId);
            updateProgressMetrics();
            updateSummary();
            saveData();
        }

        // Update rationale with character validation
        function updateRationale(practiceId, rationale) {
            // Ensure rationale doesn't exceed 32 characters
            if (rationale.length > 32) {
                rationale = rationale.substring(0, 32);
                const input = document.getElementById(`rationale-text-${practiceId}`);
                if (input) {
                    input.value = rationale;
                }
            }
            
            if (!applicabilityData[practiceId]) {
                applicabilityData[practiceId] = {};
            }
            applicabilityData[practiceId].rationale = rationale;
            updateCharacterCount(practiceId);
            saveData();
        }

        // Update character count display
        function updateCharacterCount(practiceId) {
            const input = document.getElementById(`rationale-text-${practiceId}`);
            const countDisplay = document.getElementById(`current-count-${practiceId}`);
            const countContainer = document.getElementById(`char-count-${practiceId}`);
            
            if (input && countDisplay && countContainer) {
                const currentLength = input.value.length;
                countDisplay.textContent = currentLength;
                
                // Update styling based on character count
                countContainer.classList.remove('warning', 'limit');
                if (currentLength >= 32) {
                    countContainer.classList.add('limit');
                } else if (currentLength >= 25) {
                    countContainer.classList.add('warning');
                }
            }
        }

        // Update practice display
        function updatePracticeDisplay(practiceId) {
            const practiceItem = document.querySelector(`[data-practice-id="${practiceId}"]`);
            if (!practiceItem) return;

            const status = getApplicabilityStatus(practiceId);
            const statusElement = practiceItem.querySelector('.practice-status');
            const rationaleSection = practiceItem.querySelector(`#rationale-${practiceId}`);

            // Update status display
            statusElement.className = `practice-status ${getStatusClass(status)}`;
            statusElement.textContent = getStatusLabel(status);

            // Show/hide rationale section and update character count
            if (status === 'not-applicable') {
                rationaleSection.classList.add('show');
                updateCharacterCount(practiceId);
            } else {
                rationaleSection.classList.remove('show');
            }
        }

        // Get applicability status
        function getApplicabilityStatus(practiceId) {
            return applicabilityData[practiceId]?.status || 'pending';
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch (status) {
                case 'applicable': return 'status-applicable';
                case 'not-applicable': return 'status-not-applicable';
                default: return 'status-pending';
            }
        }

        // Get status label
        function getStatusLabel(status) {
            switch (status) {
                case 'applicable': return 'Applicable';
                case 'not-applicable': return 'Not Applicable';
                default: return 'Pending Review';
            }
        }

        // Calculate domain progress
        function calculateDomainProgress(domain) {
            const applicable = domain.practices.filter(p => getApplicabilityStatus(p.id) === 'applicable').length;
            const notApplicable = domain.practices.filter(p => getApplicabilityStatus(p.id) === 'not-applicable').length;
            const pending = domain.practices.length - applicable - notApplicable;
            
            return { applicable, notApplicable, pending };
        }

        // Update progress metrics
        function updateProgressMetrics() {
            const allPractices = [];
            nistControls.domains.forEach(domain => {
                allPractices.push(...domain.practices);
            });

            const metrics = {
                total: allPractices.length,
                applicable: 0,
                notApplicable: 0,
                pending: 0
            };

            allPractices.forEach(practice => {
                const status = getApplicabilityStatus(practice.id);
                metrics[status === 'not-applicable' ? 'notApplicable' : status]++;
            });

            metrics.pending = metrics.total - metrics.applicable - metrics.notApplicable;

            // Update display
            document.getElementById('totalControls').textContent = metrics.total;
            document.getElementById('applicableControls').textContent = metrics.applicable;
            document.getElementById('applicablePercentage').textContent = `${Math.round((metrics.applicable / metrics.total) * 100)}%`;
            document.getElementById('notApplicableControls').textContent = metrics.notApplicable;
            document.getElementById('notApplicablePercentage').textContent = `${Math.round((metrics.notApplicable / metrics.total) * 100)}%`;
            document.getElementById('pendingControls').textContent = metrics.pending;
            document.getElementById('pendingPercentage').textContent = `${Math.round((metrics.pending / metrics.total) * 100)}%`;
            document.getElementById('implementationRequired').textContent = metrics.applicable;

            // Update progress bar
            const progressPercentage = Math.round(((metrics.applicable + metrics.notApplicable) / metrics.total) * 100);
            document.getElementById('totalProgress').style.width = `${progressPercentage}%`;
        }

        // Filter functions
        function filterByLevel(level) {
            currentFilter = level;
            setActiveFilter(`filter-${level}`);
            applyFilters();
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            setActiveFilter(`filter-${status}`);
            applyFilters();
        }

        function setActiveFilter(activeId) {
            document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
            document.getElementById(activeId).classList.add('active');
        }

        function applyFilters() {
            const practices = document.querySelectorAll('.practice-item');
            
            practices.forEach(practice => {
                let show = true;
                
                // Level filter
                if (currentFilter !== 'all' && !isNaN(currentFilter)) {
                    const practiceLevel = parseInt(practice.getAttribute('data-level'));
                    if (practiceLevel !== currentFilter) {
                        show = false;
                    }
                }
                
                // Status filter
                if (currentStatusFilter !== 'all') {
                    const practiceId = practice.getAttribute('data-practice-id');
                    const status = getApplicabilityStatus(practiceId);
                    if (status !== currentStatusFilter) {
                        show = false;
                    }
                }
                
                practice.style.display = show ? 'block' : 'none';
            });

            // Hide domains with no visible practices
            nistControls.domains.forEach(domain => {
                const domainCard = document.querySelector(`[data-domain="${domain.id}"]`);
                const visiblePractices = domainCard.querySelectorAll('.practice-item[style="display: block;"], .practice-item:not([style*="none"])');
                domainCard.style.display = visiblePractices.length > 0 ? 'block' : 'none';
            });
        }

        // Search controls
        function searchControls(query) {
            const practices = document.querySelectorAll('.practice-item');
            const searchTerm = query.toLowerCase();
            
            practices.forEach(practice => {
                const practiceId = practice.querySelector('.practice-id').textContent.toLowerCase();
                const description = practice.querySelector('.practice-description').textContent.toLowerCase();
                
                const matches = practiceId.includes(searchTerm) || description.includes(searchTerm);
                
                if (query === '' || matches) {
                    practice.style.display = 'block';
                } else {
                    practice.style.display = 'none';
                }
            });
        }

        // Batch operations
        function markAllApplicable() {
            if (confirm('Mark all controls as applicable? This will override existing selections.')) {
                nistControls.domains.forEach(domain => {
                    domain.practices.forEach(practice => {
                        applicabilityData[practice.id] = { status: 'applicable', rationale: '' };
                        updateCheckboxes(practice.id, 'applicable');
                        updatePracticeDisplay(practice.id);
                    });
                });
                updateProgressMetrics();
                updateSummary();
                saveData();
            }
        }

        function markLevelApplicable(level) {
            if (confirm(`Mark all Level ${level} controls as applicable?`)) {
                nistControls.domains.forEach(domain => {
                    domain.practices.forEach(practice => {
                        if (practice.level === level) {
                            applicabilityData[practice.id] = { status: 'applicable', rationale: '' };
                            updateCheckboxes(practice.id, 'applicable');
                            updatePracticeDisplay(practice.id);
                        }
                    });
                });
                updateProgressMetrics();
                updateSummary();
                saveData();
            }
        }

        function clearAllSelections() {
            if (confirm('Clear all selections? This action cannot be undone.')) {
                applicabilityData = {};
                generateControlsInterface();
                updateProgressMetrics();
                updateSummary();
                saveData();
            }
        }

        function updateCheckboxes(practiceId, status) {
            const applicableCheckbox = document.getElementById(`applicable-${practiceId}`);
            const notApplicableCheckbox = document.getElementById(`not-applicable-${practiceId}`);
            
            if (applicableCheckbox && notApplicableCheckbox) {
                applicableCheckbox.checked = (status === 'applicable');
                notApplicableCheckbox.checked = (status === 'not-applicable');
            }
        }

        // Update summary
        function updateSummary() {
            const summaryGrid = document.getElementById('summaryGrid');
            
            const domainSummaries = nistControls.domains.map(domain => {
                const progress = calculateDomainProgress(domain);
                return {
                    name: domain.name,
                    applicable: progress.applicable,
                    notApplicable: progress.notApplicable,
                    pending: progress.pending,
                    total: domain.practices.length,
                    completionRate: Math.round(((progress.applicable + progress.notApplicable) / domain.practices.length) * 100)
                };
            });

            summaryGrid.innerHTML = domainSummaries.map(summary => `
                <div class="summary-card">
                    <h4>${summary.name}</h4>
                    <div style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Applicable:</span>
                            <strong style="color: #28a745;">${summary.applicable}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Not Applicable:</span>
                            <strong style="color: #dc3545;">${summary.notApplicable}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Pending:</span>
                            <strong style="color: #ffc107;">${summary.pending}</strong>
                        </div>
                        <div style="margin-top: 10px; font-weight: 600;">
                            Completion: ${summary.completionRate}%
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${summary.completionRate}%"></div>
                    </div>
                </div>
            `).join('');
        }

        // Export functions
        function exportApplicabilityMatrix() {
            const orgName = document.getElementById('orgName').value || 'Organization';
            const cisoName = document.getElementById('cisoName').value || 'CISO';
            const assessmentDate = document.getElementById('assessmentDate').value || new Date().toISOString().split('T')[0];
            
            let csvContent = `NIST SP 800-171 Applicability Matrix\n`;
            csvContent += `Organization: ${orgName}\n`;
            csvContent += `CISO: ${cisoName}\n`;
            csvContent += `Assessment Date: ${assessmentDate}\n\n`;
            csvContent += `Control ID,Domain,Level,Description,Status,Rationale\n`;

            nistControls.domains.forEach(domain => {
                domain.practices.forEach(practice => {
                    const status = getApplicabilityStatus(practice.id);
                    const rationale = applicabilityData[practice.id]?.rationale || '';
                    csvContent += `"${practice.id}","${domain.name}",${practice.level},"${practice.description}","${status}","${rationale}"\n`;
                });
            });

            downloadFile(csvContent, `${orgName}_NIST_171_Applicability_Matrix_${assessmentDate}.csv`, 'text/csv');
        }

        function exportImplementationList() {
            const orgName = document.getElementById('orgName').value || 'Organization';
            const applicablePractices = [];
            
            nistControls.domains.forEach(domain => {
                domain.practices.forEach(practice => {
                    if (getApplicabilityStatus(practice.id) === 'applicable') {
                        applicablePractices.push({
                            ...practice,
                            domain: domain.name
                        });
                    }
                });
            });

            let content = `NIST SP 800-171 Implementation List\n`;
            content += `Organization: ${orgName}\n`;
            content += `Generated: ${new Date().toLocaleString()}\n`;
            content += `Total Applicable Controls: ${applicablePractices.length}\n\n`;

            content += `CONTROLS REQUIRING IMPLEMENTATION:\n`;
            content += `===============================================\n\n`;

            const groupedByDomain = {};
            applicablePractices.forEach(practice => {
                if (!groupedByDomain[practice.domain]) {
                    groupedByDomain[practice.domain] = [];
                }
                groupedByDomain[practice.domain].push(practice);
            });

            Object.keys(groupedByDomain).forEach(domainName => {
                content += `${domainName}\n`;
                content += `${'='.repeat(domainName.length)}\n`;
                groupedByDomain[domainName].forEach(practice => {
                    content += `${practice.id} (Level ${practice.level})\n`;
                    content += `${practice.description}\n\n`;
                });
                content += `\n`;
            });

            downloadFile(content, `${orgName}_NIST_171_Implementation_List.txt`, 'text/plain');
        }

        function exportAuditReadiness() {
            const orgName = document.getElementById('orgName').value || 'Organization';
            const cisoName = document.getElementById('cisoName').value || 'CISO';
            
            const metrics = calculateOverallMetrics();
            
            let content = `NIST SP 800-171 Audit Readiness Report\n`;
            content += `Organization: ${orgName}\n`;
            content += `CISO: ${cisoName}\n`;
            content += `Generated: ${new Date().toLocaleString()}\n\n`;

            content += `ASSESSMENT SUMMARY\n`;
            content += `==================\n`;
            content += `Total Controls: ${metrics.total}\n`;
            content += `Applicable: ${metrics.applicable} (${Math.round((metrics.applicable / metrics.total) * 100)}%)\n`;
            content += `Not Applicable: ${metrics.notApplicable} (${Math.round((metrics.notApplicable / metrics.total) * 100)}%)\n`;
            content += `Pending Review: ${metrics.pending} (${Math.round((metrics.pending / metrics.total) * 100)}%)\n\n`;

            if (metrics.pending > 0) {
                content += `PENDING REVIEW ITEMS\n`;
                content += `====================\n`;
                nistControls.domains.forEach(domain => {
                    domain.practices.forEach(practice => {
                        if (getApplicabilityStatus(practice.id) === 'pending') {
                            content += `${practice.id}: ${practice.description}\n`;
                        }
                    });
                });
                content += `\n`;
            }

            content += `CMMC LEVEL BREAKDOWN\n`;
            content += `====================\n`;
            [1, 2, 3].forEach(level => {
                const levelPractices = [];
                nistControls.domains.forEach(domain => {
                    domain.practices.forEach(practice => {
                        if (practice.level === level && getApplicabilityStatus(practice.id) === 'applicable') {
                            levelPractices.push(practice);
                        }
                    });
                });
                content += `Level ${level}: ${levelPractices.length} applicable controls\n`;
            });

            downloadFile(content, `${orgName}_NIST_171_Audit_Readiness.txt`, 'text/plain');
        }

        function generateSSP() {
            const orgName = document.getElementById('orgName').value || 'Organization';
            
            let content = `SYSTEM SECURITY PLAN (SSP) TEMPLATE\n`;
            content += `Organization: ${orgName}\n`;
            content += `Based on NIST SP 800-171 Applicability Assessment\n`;
            content += `Generated: ${new Date().toLocaleString()}\n\n`;

            content += `1. INTRODUCTION\n`;
            content += `===============\n`;
            content += `This System Security Plan (SSP) template is based on the NIST SP 800-171 applicability assessment\n`;
            content += `conducted for ${orgName}. Only controls marked as applicable are included in this template.\n\n`;

            content += `2. APPLICABLE CONTROLS\n`;
            content += `======================\n\n`;

            nistControls.domains.forEach(domain => {
                const applicablePractices = domain.practices.filter(p => getApplicabilityStatus(p.id) === 'applicable');
                
                if (applicablePractices.length > 0) {
                    content += `${domain.name}\n`;
                    content += `${'-'.repeat(domain.name.length)}\n\n`;
                    
                    applicablePractices.forEach(practice => {
                        content += `Control: ${practice.id}\n`;
                        content += `Level: ${practice.level}\n`;
                        content += `Requirement: ${practice.description}\n`;
                        content += `Implementation Status: [TO BE COMPLETED]\n`;
                        content += `Implementation Description: [DESCRIBE HOW THIS CONTROL IS IMPLEMENTED]\n`;
                        content += `Responsible Parties: [LIST RESPONSIBLE PERSONNEL/ROLES]\n`;
                        content += `Implementation Evidence: [DESCRIBE EVIDENCE OF IMPLEMENTATION]\n`;
                        content += `\n`;
                    });
                    content += `\n`;
                }
            });

            downloadFile(content, `${orgName}_SSP_Template.txt`, 'text/plain');
        }

        function showValidationReport() {
            const validationModal = document.getElementById('validationModal');
            const validationContent = document.getElementById('validationContent');
            
            const validation = performValidation();
            
            validationContent.innerHTML = `
                <div class="validation-summary">
                    <h3>Validation Summary</h3>
                    <div style="margin: 15px 0;">
                        <div style="color: ${validation.errors.length > 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">
                            ${validation.errors.length === 0 ? '✓ Assessment Complete' : `⚠ ${validation.errors.length} Issues Found`}
                        </div>
                        <div style="margin-top: 10px;">
                            Completion Rate: ${validation.completionRate}%
                        </div>
                    </div>
                </div>

                ${validation.errors.length > 0 ? `
                    <div class="validation-errors">
                        <h4 style="color: #dc3545;">Issues to Address:</h4>
                        <ul style="margin: 10px 0;">
                            ${validation.errors.map(error => `<li style="margin: 5px 0;">${error}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${validation.warnings.length > 0 ? `
                    <div class="validation-warnings">
                        <h4 style="color: #ffc107;">Recommendations:</h4>
                        <ul style="margin: 10px 0;">
                            ${validation.warnings.map(warning => `<li style="margin: 5px 0;">${warning}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                <div class="validation-stats">
                    <h4>Assessment Statistics:</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                        <div>Applicable Controls: ${validation.stats.applicable}</div>
                        <div>Not Applicable: ${validation.stats.notApplicable}</div>
                        <div>Pending Review: ${validation.stats.pending}</div>
                        <div>Total Controls: ${validation.stats.total}</div>
                    </div>
                </div>
            `;
            
            validationModal.style.display = 'block';
        }

        function performValidation() {
            const errors = [];
            const warnings = [];
            const stats = calculateOverallMetrics();
            
            // Check for required organization information
            if (!document.getElementById('orgName').value.trim()) {
                errors.push('Organization name is required');
            }
            if (!document.getElementById('cisoName').value.trim()) {
                errors.push('CISO name is required');
            }
            
            // Check for pending controls
            if (stats.pending > 0) {
                errors.push(`${stats.pending} controls are still pending review`);
            }
            
            // Check for not applicable controls without rationale
            nistControls.domains.forEach(domain => {
                domain.practices.forEach(practice => {
                    if (getApplicabilityStatus(practice.id) === 'not-applicable') {
                        const rationale = applicabilityData[practice.id]?.rationale?.trim();
                        if (!rationale) {
                            errors.push(`Control ${practice.id} marked as not applicable but missing rationale`);
                        }
                    }
                });
            });
            
            // Provide warnings for common scenarios
            if (stats.applicable === 0) {
                warnings.push('No controls marked as applicable - verify this is correct for your organization');
            }
            
            if (stats.notApplicable > stats.applicable) {
                warnings.push('More controls marked as not applicable than applicable - consider reviewing assessment');
            }
            
            const completionRate = Math.round(((stats.applicable + stats.notApplicable) / stats.total) * 100);
            
            return {
                errors,
                warnings,
                stats,
                completionRate
            };
        }

        function calculateOverallMetrics() {
            const allPractices = [];
            nistControls.domains.forEach(domain => {
                allPractices.push(...domain.practices);
            });

            const metrics = {
                total: allPractices.length,
                applicable: 0,
                notApplicable: 0,
                pending: 0
            };

            allPractices.forEach(practice => {
                const status = getApplicabilityStatus(practice.id);
                if (status === 'applicable') metrics.applicable++;
                else if (status === 'not-applicable') metrics.notApplicable++;
                else metrics.pending++;
            });

            return metrics;
        }

        // Utility functions
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function saveData() {
            const data = {
                applicabilityData,
                organizationInfo: {
                    name: document.getElementById('orgName').value,
                    ciso: document.getElementById('cisoName').value,
                    assessmentDate: document.getElementById('assessmentDate').value,
                    cuiCategories: Array.from(document.getElementById('cuiCategories').selectedOptions).map(option => option.value)
                },
                lastSaved: new Date().toISOString()
            };
            
            // In a real implementation, this would save to a backend
            console.log('Data saved:', data);
            
            // Show save confirmation
            showNotification('Progress saved successfully', 'success');
        }

        function loadSavedData() {
            // In a real implementation, this would load from a backend
            // For demo purposes, we'll start with empty data
            console.log('Loading saved data...');
        }

        function saveProgress() {
            saveData();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transition: all 0.3s ease;
                ${type === 'success' ? 'background: #28a745;' : 'background: #17a2b8;'}
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Event handlers
        window.onclick = function(event) {
            const modal = document.getElementById('validationModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        document.addEventListener('keydown', function(event) {
            // Escape key to close modals
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
            
            // Ctrl+S to save
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                saveProgress();
            }
        });

        // Auto-save functionality
        let autoSaveTimeout;
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveData();
            }, 10000); // Auto-save every 10 seconds
        }

        // Add auto-save to critical functions
        const originalUpdateApplicability = updateApplicability;
        updateApplicability = function(practiceId, type, checked) {
            originalUpdateApplicability(practiceId, type, checked);
            scheduleAutoSave();
        };

        const originalUpdateRationale = updateRationale;
        updateRationale = function(practiceId, rationale) {
            originalUpdateRationale(practiceId, rationale);
            scheduleAutoSave();
        };

        // Form validation
        function validateForm() {
            const orgName = document.getElementById('orgName').value.trim();
            const cisoName = document.getElementById('cisoName').value.trim();
            
            let isValid = true;
            
            // Remove existing error messages
            document.querySelectorAll('.validation-error').forEach(error => error.remove());
            
            if (!orgName) {
                showFieldError('orgName', 'Organization name is required');
                isValid = false;
            }
            
            if (!cisoName) {
                showFieldError('cisoName', 'CISO name is required');
                isValid = false;
            }
            
            return isValid;
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
            field.style.borderColor = '#dc3545';
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Add form validation listeners
            document.getElementById('orgName').addEventListener('blur', validateForm);
            document.getElementById('cisoName').addEventListener('blur', validateForm);
            
            // Add CUI categories change listener
            document.getElementById('cuiCategories').addEventListener('change', saveData);
            
            // Set up periodic updates
            setInterval(() => {
                updateProgressMetrics();
                updateSummary();
            }, 30000); // Update every 30 seconds
        });

        // Integration functions for CMMC Auditor Dashboard
        function exportForAuditorDashboard() {
            const applicablePractices = [];
            
            nistControls.domains.forEach(domain => {
                domain.practices.forEach(practice => {
                    if (getApplicabilityStatus(practice.id) === 'applicable') {
                        applicablePractices.push({
                            id: practice.id,
                            description: practice.description,
                            level: practice.level,
                            domain: domain.name,
                            status: 'not-started', // Default status for auditor dashboard
                            evidenceCount: 0,
                            notes: ''
                        });
                    }
                });
            });

            const exportData = {
                organizationInfo: {
                    name: document.getElementById('orgName').value,
                    ciso: document.getElementById('cisoName').value,
                    assessmentDate: document.getElementById('assessmentDate').value
                },
                applicablePractices: applicablePractices,
                totalApplicable: applicablePractices.length,
                exportDate: new Date().toISOString()
            };

            // Create downloadable JSON file for import into auditor dashboard
            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, `${exportData.organizationInfo.name}_Applicable_Controls.json`, 'application/json');
            
            showNotification('Control list exported for auditor dashboard import', 'success');
        }

        // Add export button for auditor dashboard integration
        function addAuditorIntegrationButton() {
            const exportSection = document.querySelector('.export-controls');
            const integrationButton = document.createElement('button');
            integrationButton.className = 'btn btn-action';
            integrationButton.textContent = 'Export for Auditor Dashboard';
            integrationButton.onclick = exportForAuditorDashboard;
            exportSection.appendChild(integrationButton);
        }

        // Call this after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(addAuditorIntegrationButton, 100);
        });
    </script>
</body>
</html>
                    ]
